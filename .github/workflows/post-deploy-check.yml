name: Post-Deploy Health Check

on:
  push:
    branches: [main]

jobs:
  verify:
    runs-on: ubuntu-latest

    steps:
      - name: Wait for deployment to complete
        run: |
          echo "â³ Waiting for deployment to complete..."
          sleep 45

      - name: Check Health Endpoint with Retry
        run: |
          echo "ğŸ” Testing health endpoint with retry logic..."
          for i in {1..10}; do
            if curl -f -s http://44.253.94.252:5000/health > /dev/null; then
              echo "âœ… Health endpoint is responding"
              health_response=$(curl -s http://44.253.94.252:5000/health)
              echo "ğŸ“‹ Health response: $health_response"
              
              # Check if response contains version info (indicating new deployment)
              if [[ $health_response == *"version"* ]]; then
                echo "âœ… New version deployed successfully!"
              else
                echo "âš ï¸ Health endpoint responding but may be old version"
              fi
              break
            elif [ $i -eq 10 ]; then
              echo "âŒ Health endpoint not accessible after 10 attempts"
              exit 1
            else
              echo "â³ Attempt $i/10 - health endpoint not ready, waiting..."
              sleep 6
            fi
          done

      - name: Check Main Application
        run: |
          echo "ğŸ” Testing main application..."
          response=$(curl -s http://44.253.94.252:5000/ || echo "FAILED")
          if [[ $response == *"Task Manager"* ]]; then
            echo "âœ… Main application is responding correctly"
          else
            echo "âŒ Main application not responding properly"
            echo "Response received: $response"
            exit 1
          fi

      - name: Deployment Summary
        run: |
          echo "ğŸ‰ Post-deployment verification completed successfully!"
          echo "ğŸŒ App: http://44.253.94.252:5000"
          echo "ğŸ” Health: http://44.253.94.252:5000/health"
